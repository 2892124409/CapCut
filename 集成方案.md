# 剪映PC客户端播放器集成方案

## 1. 当前播放器模块分析

### 架构特点
- **技术栈**: Qt6 + QML + FFmpeg + OpenGL
- **核心组件**: 
  - `VideoPlayer`: 主播放器类，支持播放、暂停、拖动、音量控制
  - `VideoDecoder`/`AudioDecoder`: 音视频解码器
  - `DecoderWorker`: 多线程解码工作器
  - `FileManager`: 文件管理
- **UI界面**: 完整的播放器界面，包含进度条、控制按钮、音量调节

### 功能特性
- ✅ 本地视频播放
- ✅ 播放控制（播放/暂停/停止）
- ✅ 进度条拖动
- ✅ 音量调节
- ✅ 键盘快捷键支持
- ✅ 多文件切换
- ✅ OpenGL硬件加速渲染

## 2. 集成方案设计

### 方案一：模块化集成（推荐）
将播放器作为独立模块集成到主项目中：

```
CapCut/
├── src/
│   ├── main/                 # 主程序入口
│   ├── ui/                   # 主界面
│   ├── media/                # 播放器模块（当前目录）
│   ├── synthesis/            # 视频合成模块
│   ├── backend/              # 后端接口
│   └── common/               # 公共组件
├── resources/
└── build/
```

### 方案二：插件化集成
将播放器封装为动态库，主程序动态加载。

## 3. 具体集成步骤

### 步骤1：创建主项目结构
```bash
mkdir -p src/{main,ui,media,synthesis,backend,common}
mkdir resources build
```

### 步骤2：配置主项目CMakeLists.txt
```cmake
# 主项目CMakeLists.txt
cmake_minimum_required(VERSION 3.16)
project(CapCut VERSION 1.0 LANGUAGES CXX)

# 包含播放器模块
add_subdirectory(src/media)

# 其他模块...
add_subdirectory(src/ui)
add_subdirectory(src/synthesis)

# 主应用程序
qt_add_executable(CapCut
    src/main/main.cpp
    # 其他源文件...
)

# 链接所有模块
target_link_libraries(CapCut PRIVATE
    media_module
    ui_module
    synthesis_module
)
```

### 步骤3：修改播放器接口
需要为播放器添加与主程序通信的接口：

```cpp
// 在VideoPlayer类中添加
class VideoPlayer : public QQuickItem {
    Q_OBJECT
public:
    // 新增接口
    Q_INVOKABLE void loadStoryboard(const QString& storyboardJson);
    Q_INVOKABLE void exportVideo(const QString& outputPath);
    
signals:
    void storyboardLoaded(bool success);
    void exportFinished(bool success);
    void errorOccurred(const QString& error);
};
```

### 步骤4：创建主界面集成
```qml
// src/ui/MainWindow.qml
import QtQuick
import QtQuick.Controls
import media  // 播放器模块

ApplicationWindow {
    // 主界面布局...
    
    // 预览区域
    VideoPlayer {
        id: previewPlayer
        anchors.fill: previewArea
        onStoryboardLoaded: {
            // 处理故事板加载完成
        }
    }
    
    // 控制按钮
    Button {
        text: "播放预览"
        onClicked: {
            var storyboardData = getStoryboardFromBackend()
            previewPlayer.loadStoryboard(storyboardData)
        }
    }
}
```

### 步骤5：实现故事板数据接口
```cpp
// Storyboard数据结构
struct StoryboardItem {
    QString imagePath;
    QString audioPath;
    qint64 duration;  // 毫秒
    QString transition; // "kenburns", "crossfade", "none"
    QVariantMap transitionParams;
};

class StoryboardManager : public QObject {
    Q_OBJECT
public:
    Q_INVOKABLE QVariantList parseStoryboardJson(const QString& json);
    Q_INVOKABLE bool validateResources(const QVariantList& storyboard);
};
```

## 4. 与队友的协作接口

### 数据格式要求
```json
{
  "storyboard": [
    {
      "imagePath": "/cache/images/scene1.jpg",
      "audioPath": "/cache/audio/voice1.mp3", 
      "duration": 5000,
      "transition": "kenburns",
      "transitionParams": {
        "zoom": 1.2,
        "panX": 0.1,
        "panY": 0.1
      }
    },
    {
      "imagePath": "/cache/images/scene2.jpg",
      "audioPath": "/cache/audio/voice2.mp3",
      "duration": 3000, 
      "transition": "crossfade",
      "transitionParams": {
        "duration": 500
      }
    }
  ]
}
```

### 接口文档
- **播放器模块**: 负责视频预览播放
- **合成模块**: 负责最终视频导出
- **后端模块**: 提供故事板JSON和资源文件
- **UI模块**: 提供用户交互界面

## 5. 下一步实施计划

1. **第一阶段**: 创建主项目框架，集成播放器模块
2. **第二阶段**: 实现故事板数据解析和预览功能
3. **第三阶段**: 添加视频合成导出功能
4. **第四阶段**: 完善用户界面和交互体验

## 6. 技术要点

- 保持播放器模块的独立性，便于维护和测试
- 使用信号槽机制进行模块间通信
- 统一错误处理和日志记录
- 支持资源文件的本地缓存管理
