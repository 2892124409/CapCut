 # 视频播放器进度拖动问题总结

  ## 原因
  - **旧音频继续播**：拖动后音频沿用旧缓冲/时钟输出，视频等待对齐或丢帧，出现“画面卡住、音频从旧位置播、进度回跳”。
  - **Seek 未暂停和清空**：未暂停 demux/解码器并清空队列，旧包/旧帧仍被消费，进度被落后音频时钟拉回。
  - **目标未锁定**：未对 seek 目标做严格保护，音频/视频在到达目标前仍按旧时钟推进，导致回跳和卡顿。
  - **EOF 后拖动重载**：重载时未保留目标位置，易从头播放。

  ## 解决方案
  - **暂停与刷新**：Seek 前暂停定时器、Demuxer、音视频解码器，清空各自缓冲/队列，避免旧数据继续输出。
  - **立即同步位置**：将当前位置和音频时钟直接设为目标时间，立即发出 `positionChanged`，进度条瞬时对齐拖动位置。
  - **目标锁定 + 宽限期**：
    - 记录 `m_seekTargetMs`，宽限期内视频不等待落后音频，早于目标的帧直接丢弃；落后目标的音频时钟被忽略，防止回跳。
    - 达到目标或宽限期超时后清除锁定，恢复正常音视频对齐。
  - **音频丢弃策略**：新增 `setDropUntil`，当音频 PTS 早于目标时不写输出、不推进时钟，避免旧音频拖回进度。
  - **EOF 拖动重载**：重载时携带 seek 目标并保持暂停，避免自动从头播放。
  - **调试日志**：增加 `VP::seek`、`VP::audioClock skip/set`、`VP::render early frame` 等日志，便于排查同步状态。

  ## 效果
  - 拖动后音频不再从旧位置播放，画面不会卡住等音频；进度条不回跳，音画从拖动目标快速同步播放。


 # 音频拖动后残留旧声音问题

  ## 原因
  - Seek 时仅刷新解码器缓冲，但 `QAudioSink` 输出缓冲仍存有旧样本，导致拖动后先播放一段旧音频。
  - 旧音频样本写入设备后，音频时钟也会滞后目标，进度短暂回跳。

  ## 解决方案
  - 在 `AudioPlayer::seek` 中，执行：`requestFlush()` + `setDropUntil(target)`，并调用 `AudioDecoder::hardResetOutput()`
  重新创建 `QAudioSink`，彻底清空输出缓冲。
  - `AudioDecoder::processPacket` 中根据 `dropUntil` 丢弃目标之前的帧，不写入音频设备，也不推进时钟，直到达到目标后才
  恢复。
  - 钳位音频时钟到目标时间，防止回跳拉动进度条。

  ## 效果
  - 拖动后不再播放拖动前的残留音频，音频和进度从目标位置直接开始输出。  